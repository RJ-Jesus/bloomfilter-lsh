FROM: Gary Peck <gbpeck@sbcglobal.net>
TO: rpm-zzzlist@freshrpms.net
SUBJECT: Re: alsa-driver.spec tweak for homemade kernels

--- alsa-driver.spec.orig	2002-10-02 12:25:26.000000000 -0700
+++ alsa-driver.spec	2002-10-01 21:23:19.000000000 -0700
@@ -3,9 +3,12 @@
 # Comma separated list of cards for which to compile a driver
 %define	cards		all
 
-%define	kunamer		%(uname -r)
-%define	kversion	%(echo $(uname -r) | sed -e s/smp// -)
-%if %(uname -r | grep -c smp)
+%if %(printenv TARGET_KERNEL >/dev/null && echo -n 1 || echo -n 0)
+%define usekernel	%(echo -n $TARGET_KERNEL)
+%endif
+%define	kunamer		%{!?usekernel: %(uname -r)}%{?usekernel}
+%define	kversion	%(echo %{kunamer} | sed -e s/smp// -)
+%if %(echo %{kunamer} | grep -c smp)
 	%{expand:%%define ksmp -smp}
 %endif
 %define	karch		%(rpm -q --qf '%%{arch}' kernel%{?ksmp}-%{kversion})
@@ -77,6 +80,7 @@
 	%{?_without_isapnp:--with-isapnp=no} \
 	%{?_without_sequencer:--with-sequencer=no} \
 	%{?_without_oss:--with-oss=no} \
+	%{?usekernel:--with-kernel=/lib/modules/%{usekernel}/build} \
 	--with-cards=%{cards}
 make
 
@@ -106,10 +109,10 @@
 rm -f %{buildroot}/etc/rc.d/init.d/alsasound
 
 %post -n alsa-kernel%{?ksmp}
-/sbin/depmod -a
+/sbin/depmod -a -F /boot/System.map-%{kunamer} %{kunamer}
 
 %postun -n alsa-kernel%{?ksmp}
-/sbin/depmod -a
+/sbin/depmod -a -F /boot/System.map-%{kunamer} %{kunamer}
 
 %clean
 rm -rf %{buildroot}